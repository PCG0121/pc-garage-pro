<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PC Garage Pro - Advanced Service Tracking</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3a0ca3;
            --success: #4cc9f0;
            --warning: #f72585;
            --light: #f8f9fa;
            --dark: #212529;
        }
        
        * {
            font-family: 'Poppins', sans-serif;
        }
        
        .sidebar {
            width: 280px;
            background: linear-gradient(180deg, var(--primary) 0%, var(--secondary) 100%);
            transition: all 0.3s;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
        }
        
        .nav-item {
            padding: 12px 20px;
            margin: 5px 15px;
            border-radius: 8px;
            transition: all 0.3s;
            color: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .nav-item:hover, .nav-item.active {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .nav-item i {
            width: 20px;
            text-align: center;
        }
        
        .loader {
            border-top-color: var(--primary);
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
            border-radius: 8px;
            padding: 10px 20px;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .btn-primary:hover {
            background: var(--secondary);
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(67, 97, 238, 0.3);
        }
        
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            transition: all 0.3s;
            border: none;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        
        .status-badge {
            padding: 0.4rem 0.8rem;
            border-radius: 50px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .status-pending { background-color: #fff4e6; color: #f76707; }
        .status-inprogress { background-color: #e3fafc; color: #0c8599; }
        .status-completed { background-color: #e6fcf5; color: #087f5b; }
        
        .fade-in { animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .notification-bell { position: relative; cursor: pointer; }
        .notification-badge { position: absolute; top: -5px; right: -5px; background: var(--warning); color: white; font-size: 0.7rem; width: 18px; height: 18px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        
        .notification-dropdown {
            position: absolute;
            top: 40px;
            right: 0;
            width: 350px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            z-index: 100;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .notification-item {
            padding: 12px 15px;
            border-bottom: 1px solid #f1f3f4;
            cursor: pointer;
        }
        
        .notification-item:hover {
            background-color: #f8f9fa;
        }
        
        .notification-item.unread {
            background-color: #eef7ff;
        }
        
        .notification-warning { border-left: 4px solid #ffc107; }
        .notification-success { border-left: 4px solid #28a745; }
        .notification-error { border-left: 4px solid #dc3545; }
        .notification-info { border-left: 4px solid #17a2b8; }
        
        .search-box {
            transition: all 0.3s;
        }
        
        .search-box:focus {
            width: 250px;
        }
        
        .chart-container {
            position: relative;
            height: 250px;
        }
        
        @media (max-width: 768px) {
            .sidebar {
                width: 70px;
            }
            
            .sidebar .nav-text {
                display: none;
            }
            
            .main-content {
                margin-left: 70px;
            }
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, createContext, useContext } = React;
        
        const API_URL = 'https://pc-garage-pro-production.up.railway.app/api';

        // --- Reusable API Hook ---
        const useApi = (endpoint, requiresAuth = true) => {
            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            
            const auth = useAuth();

            const fetchData = async () => {
                try {
                    setLoading(true);
                    const headers = {};
                    
                    if (requiresAuth && auth.token) {
                        headers['Authorization'] = `Bearer ${auth.token}`;
                    }
                    
                    const res = await fetch(`${API_URL}/${endpoint}`, { headers });
                    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                    const result = await res.json();
                    setData(result);
                } catch (err) {
                    console.error(`Error fetching ${endpoint}:`, err);
                    setError(err);
                } finally {
                    setLoading(false);
                }
            };

            useEffect(() => {
                if (!requiresAuth || auth.user) {
                    fetchData();
                }
            }, [endpoint, auth.user]);

            const addItem = async (item) => {
                const headers = { 'Content-Type': 'application/json' };
                
                if (requiresAuth && auth.token) {
                    headers['Authorization'] = `Bearer ${auth.token}`;
                }

                const res = await fetch(`${API_URL}/${endpoint}`, {
                    method: 'POST',
                    headers,
                    body: JSON.stringify(item),
                });
                if (!res.ok) {
                    const errData = await res.json().catch(() => ({ message: 'Failed to add item' }));
                    throw new Error(errData.message);
                }
                const newItem = await res.json();
                await fetchData();
                return newItem;
            };

            const updateItem = async (id, item) => {
                const headers = { 'Content-Type': 'application/json' };

                if (requiresAuth && auth.token) {
                    headers['Authorization'] = `Bearer ${auth.token}`;
                }

                const res = await fetch(`${API_URL}/${endpoint}/${id}`, {
                    method: 'PUT',
                    headers,
                    body: JSON.stringify(item),
                });
                if (!res.ok) {
                    const errData = await res.json().catch(() => ({ message: 'Failed to update item' }));
                    throw new Error(errData.message);
                }
                const updatedItem = await res.json();
                await fetchData();
                return updatedItem;
            };

            const deleteItem = async (id) => {
                const headers = {};

                if (requiresAuth && auth.token) {
                    headers['Authorization'] = `Bearer ${auth.token}`;
                }

                await fetch(`${API_URL}/${endpoint}/${id}`, {
                    method: 'DELETE',
                    headers
                });
                await fetchData();
            };

            return { data, loading, error, addItem, updateItem, deleteItem, refetch: fetchData };
        };
        
        // Auth Context
        const AuthContext = createContext();
        const useAuth = () => useContext(AuthContext);
        const AuthProvider = ({ children }) => {
            const [user, setUser] = useState(null);
            const [token, setToken] = useState(null);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                try {
                    const savedUser = JSON.parse(localStorage.getItem('currentUser'));
                    const savedToken = localStorage.getItem('authToken');
                    
                    if (savedUser && savedToken) {
                        setUser(savedUser);
                        setToken(savedToken);
                    }
                } catch (e) {
                    console.error("Failed to parse user from localStorage", e);
                }
                setLoading(false);
            }, []);

            const login = async (email, password) => {
                try {
                    const response = await fetch(`${API_URL}/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, password }),
                    });
                    
                    const data = await response.json();
                    
                    if (!response.ok) {
                        return { error: data.message || 'Login failed' };
                    }
                    
                    localStorage.setItem('currentUser', JSON.stringify(data.user));
                    localStorage.setItem('authToken', data.token);
                    setUser(data.user);
                    setToken(data.token);
                    
                    return { success: true };
                } catch (error) {
                    return { error: 'Network error. Please try again.' };
                }
            };
            
            const register = async (name, email, password, role) => {
                try {
                    const response = await fetch(`${API_URL}/register`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name, email, password, role }),
                    });
                    
                    const data = await response.json();
                    
                    if (!response.ok) {
                        return { error: data.message || 'Registration failed' };
                    }
                    
                    return { success: true, message: data.message };
                } catch (error) {
                    return { error: 'Network error. Please try again.' };
                }
            };

            const logout = () => {
                localStorage.removeItem('currentUser');
                localStorage.removeItem('authToken');
                setUser(null);
                setToken(null);
                window.location.hash = '#/login';
            };

            return (
                <AuthContext.Provider value={{ user, token, login, register, logout, loading }}>
                    {children}
                </AuthContext.Provider>
            );
        };

        // Utility functions
        const formatDate = (dateString) => {
            if (!dateString) return 'N/A';
            return new Date(dateString).toLocaleDateString('en-CA');
        };
        
        const formatDateTime = (dateString) => {
            if (!dateString) return 'N/A';
            return new Date(dateString).toLocaleString();
        };
        
        const formatWhatsAppNumber = (phone) => {
            if (!phone) return '';
            const cleaned = phone.replace(/\D/g, '');

            // Already has Sri Lankan country code
            if (cleaned.startsWith('94')) {
                return cleaned;
            }
            // Handle local 10-digit numbers starting with 0 (e.g., 0712345678)
            if (cleaned.length === 10 && cleaned.startsWith('0')) {
                return `94${cleaned.substring(1)}`;
            }
            // Fallback for other formats
            return cleaned;
        };

        const getStatusClass = (status) => ({
            'Pending': 'status-pending',
            'In Progress': 'status-inprogress',
            'Completed': 'status-completed'
        }[status] || 'status-pending');

        // --- Components ---
        const Dashboard = () => {
            const { data: stats, loading: statsLoading } = useApi('dashboard/stats');
            const { data: statusData, loading: statusLoading } = useApi('jobs/chart/status');
            const { data: revenueData, loading: revenueLoading } = useApi('jobs/chart/revenue');
            const { data: notifications } = useApi('notifications');
            const [statusChart, setStatusChart] = useState(null);
            const [revenueChart, setRevenueChart] = useState(null);
            
            const statusColors = {
                'Pending': '#ffc107',
                'In Progress': '#17a2b8',
                'Completed': '#28a745',
                'Cancelled': '#dc3545'
            };

            useEffect(() => {
                const ctx = document.getElementById('statusChart');
                if (!ctx) return;
                if (statusChart) statusChart.destroy();

                if (statusData && statusData.length > 0) {
                    const labels = statusData.map(item => item._id);
                    const data = statusData.map(item => item.count);
                    const backgroundColors = labels.map(label => statusColors[label] || '#6c757d');

                    const newChart = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: labels,
                            datasets: [{
                                data: data,
                                backgroundColor: backgroundColors,
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom'
                                }
                            }
                        }
                    });
                    setStatusChart(newChart);
                }
            }, [statusData]);
            
            useEffect(() => {
                if (revenueData && revenueData.length > 0) {
                    const ctx = document.getElementById('revenueChart');
                    if (ctx) {
                        if (revenueChart) revenueChart.destroy();
                        
                        const labels = revenueData.map(item => `${item._id.month}/${item._id.year}`);
                        
                        const newChart = new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: labels,
                                datasets: [{
                                    label: 'Revenue (Rs)',
                                    data: revenueData.map(item => item.revenue),
                                    backgroundColor: '#4361ee',
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                scales: {
                                    y: {
                                        beginAtZero: true
                                    }
                                }
                            }
                        });
                        
                        setRevenueChart(newChart);
                    }
                }
            }, [revenueData]);
            
            if (statsLoading) return <div className="text-center p-8">Loading Dashboard...</div>;
            
            const unreadNotifications = notifications ? notifications.filter(n => !n.read).length : 0;

            return (
                 <div className="fade-in space-y-6">
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        {/* Stat Cards */}
                        <div className="card p-6">
                            <div className="flex items-center">
                                <div className="p-3 rounded-full bg-blue-100 text-blue-600 mr-4">
                                    <i className="fas fa-tools text-xl"></i>
                                </div>
                                <div>
                                    <h3 className="text-sm font-medium text-gray-600">Total Jobs</h3>
                                    <p className="text-3xl font-bold">{stats?.totalJobs || 0}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div className="card p-6">
                            <div className="flex items-center">
                                <div className="p-3 rounded-full bg-orange-100 text-orange-600 mr-4">
                                    <i className="fas fa-clock text-xl"></i>
                                </div>
                                <div>
                                    <h3 className="text-sm font-medium text-gray-600">Pending Jobs</h3>
                                    <p className="text-3xl font-bold">{stats?.pendingJobs || 0}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div className="card p-6">
                            <div className="flex items-center">
                                <div className="p-3 rounded-full bg-green-100 text-green-600 mr-4">
                                    <i className="fas fa-check-circle text-xl"></i>
                                </div>
                                <div>
                                    <h3 className="text-sm font-medium text-gray-600">Completed Jobs</h3>
                                    <p className="text-3xl font-bold">{stats?.completedJobs || 0}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div className="card p-6">
                            <div className="flex items-center">
                                <div className="p-3 rounded-full bg-purple-100 text-purple-600 mr-4">
                                    <i className="fas fa-rupee-sign text-xl"></i>
                                </div>
                                <div>
                                    <h3 className="text-sm font-medium text-gray-600">Total Revenue</h3>
                                    <p className="text-3xl font-bold">Rs{stats?.totalRevenue?.toFixed(2) || '0.00'}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div className="card p-6">
                            <h3 className="text-lg font-semibold mb-4">Job Status Distribution</h3>
                            <div className="chart-container">
                                <canvas id="statusChart"></canvas>
                                {statusLoading && <div className="absolute inset-0 flex items-center justify-center text-gray-500">Loading...</div>}
                                {!statusLoading && (!statusData || statusData.length === 0) && (
                                    <div className="absolute inset-0 flex items-center justify-center text-gray-500">
                                        <div className="text-center">
                                            <i className="fas fa-chart-pie text-3xl text-gray-300 mb-2"></i>
                                            <p>No job data available.</p>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                        
                        <div className="card p-6">
                            <h3 className="text-lg font-semibold mb-4">Monthly Revenue</h3>
                            <div className="chart-container">
                                <canvas id="revenueChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div className="card p-6">
                            <h3 className="text-lg font-semibold mb-4">Recent Activity</h3>
                            <div className="space-y-4">
                                {notifications && notifications.slice(0, 5).map(notification => (
                                    <div key={notification._id} className={`flex items-start p-3 rounded-lg ${!notification.read ? 'bg-blue-50' : ''}`}>
                                        <div className={`mr-3 mt-1 p-2 rounded-full ${notification.type === 'warning' ? 'bg-yellow-100 text-yellow-600' : 
                                            notification.type === 'success' ? 'bg-green-100 text-green-600' : 
                                            notification.type === 'error' ? 'bg-red-100 text-red-600' : 'bg-blue-100 text-blue-600'}`}>
                                            <i className={`fas ${notification.type === 'warning' ? 'fa-exclamation-triangle' : 
                                                notification.type === 'success' ? 'fa-check-circle' : 
                                                notification.type === 'error' ? 'fa-times-circle' : 'fa-info-circle'}`}></i>
                                        </div>
                                        <div className="flex-1">
                                            <p className="font-medium">{notification.title}</p>
                                            <p className="text-sm text-gray-600">{notification.message}</p>
                                            <p className="text-xs text-gray-400 mt-1">{formatDateTime(notification.createdAt)}</p>
                                        </div>
                                    </div>
                                ))}
                                {notifications && notifications.length === 0 && !statsLoading && (
                                    <div className="text-center py-8 text-gray-500">
                                        <i className="fas fa-history text-3xl text-gray-300 mb-2"></i>
                                        <p>No recent activity.</p>
                                    </div>
                                )}
                            </div>
                        </div>
                        
                        <div className="card p-6">
                            <h3 className="text-lg font-semibold mb-4">Quick Actions</h3>
                            <div className="grid grid-cols-2 gap-4">
                                <a href="#/jobs" className="p-4 bg-blue-50 rounded-lg text-center hover:bg-blue-100 transition-colors">
                                    <div className="p-2 bg-blue-100 rounded-full inline-block mb-2">
                                        <i className="fas fa-tools text-blue-600"></i>
                                    </div>
                                    <p className="font-medium">New Job</p>
                                </a>
                                
                                <a href="#/inventory" className="p-4 bg-green-50 rounded-lg text-center hover:bg-green-100 transition-colors">
                                    <div className="p-2 bg-green-100 rounded-full inline-block mb-2">
                                        <i className="fas fa-boxes text-green-600"></i>
                                    </div>
                                    <p className="font-medium">Inventory</p>
                                </a>
                                
                                <a href="#/customers" className="p-4 bg-purple-50 rounded-lg text-center hover:bg-purple-100 transition-colors">
                                    <div className="p-2 bg-purple-100 rounded-full inline-block mb-2">
                                        <i className="fas fa-users text-purple-600"></i>
                                    </div>
                                    <p className="font-medium">Customers</p>
                                </a>
                                
                                <a href="#/settings" className="p-4 bg-orange-50 rounded-lg text-center hover:bg-orange-100 transition-colors">
                                    <div className="p-2 bg-orange-100 rounded-full inline-block mb-2">
                                        <i className="fas fa-cog text-orange-600"></i>
                                    </div>
                                    <p className="font-medium">Settings</p>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };
        
        const Jobs = () => {
            const { data: jobs, loading, error, addItem, updateItem, deleteItem, refetch: refetchJobs } = useApi('jobs');
            const { data: customers, addItem: addCustomer } = useApi('customers');
            const { data: inventory, updateItem: updateInventoryItem } = useApi('inventory');
            const { data: users } = useApi('users');
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingJob, setEditingJob] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const [statusFilter, setStatusFilter] = useState('All');
            const auth = useAuth();
            
            const handleCreate = () => { setEditingJob(null); setIsModalOpen(true); };
            const handleEdit = (job) => { setEditingJob(job); setIsModalOpen(true); };
            
            const handleSave = async (jobData) => {
                let savedJob;
                if (editingJob) {
                    savedJob = await updateItem(editingJob._id, jobData);
                } else {
                    const sequentialJobNumbers = jobs
                        .map(job => {
                            // Match formats like "PCG 1001"
                            const match = job.jobId && job.jobId.match(/^PCG\s(\d+)$/);
                            return match ? parseInt(match[1], 10) : null;
                        })
                        .filter(num => num !== null);
                    
                    let nextJobNumber = 1001;
                    if (sequentialJobNumbers.length > 0) {
                        nextJobNumber = Math.max(...sequentialJobNumbers) + 1;
                    }

                    const newJobData = { ...jobData, jobId: `PCG ${nextJobNumber}` };
                    savedJob = await addItem(newJobData);
                    const customerExists = customers.some(c => c.email === jobData.customerEmail && jobData.customerEmail);
                    if (!customerExists) {
                        await addCustomer({ name: jobData.customerName, email: jobData.customerEmail, phone: jobData.customerPhone });
                    }
                }
                return savedJob;
            };
            
            const handleCompleteJob = async (jobId) => {
                try {
                    const response = await fetch(`${API_URL}/jobs/${jobId}/complete`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${auth.token}` }
                    });
                    
                    if (response.ok) {
                        // Refetch jobs to update the UI
                        refetchJobs();
                    } else {
                        console.error('Failed to complete job');
                    }
                } catch (error) {
                    console.error('Error completing job:', error);
                }
            };

            const handleSendNote = async (jobId, noteText, customerPhone) => {
                if (!customerPhone) {
                    alert('Customer phone number is not available to send a note.');
                    return;
                }
                try {
                    const response = await fetch(`${API_URL}/jobs/${jobId}/send-note`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${auth.token}`
                        },
                        body: JSON.stringify({ note: noteText, phone: customerPhone })
                    });
                    const result = await response.json();
                    if (response.ok) {
                        alert('Note sent to customer successfully!');
                    } else {
                        alert(`Failed to send note: ${result.message || 'Unknown error'}`);
                    }
                } catch (error) {
                    console.error('Error sending note:', error);
                    alert('An error occurred while sending the note.');
                }
            };

            const filteredJobs = jobs ? jobs.filter(job => {
                const matchesSearch = job.jobId.toLowerCase().includes(searchTerm.toLowerCase()) ||
                                    job.customerName.toLowerCase().includes(searchTerm.toLowerCase()) ||
                                    job.deviceModel.toLowerCase().includes(searchTerm.toLowerCase());
                
                const matchesStatus = statusFilter === 'All' || job.status === statusFilter;
                
                return matchesSearch && matchesStatus;
            }) : [];

            if (loading) return <div className="text-center p-8">Loading Jobs...</div>;
            if (error) return <div className="text-center p-8 text-red-500">Error: Could not load jobs. Is the backend server running?</div>;

            return (
                <div className="fade-in">
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-2xl font-semibold">Repair Jobs</h2>
                        <button onClick={handleCreate} className="btn-primary flex items-center gap-2"><i className="fas fa-plus"></i> New Job</button>
                    </div>
                    
                    <div className="card p-4 mb-6">
                        <div className="flex flex-col md:flex-row gap-4">
                            <div className="flex-1">
                                <div className="relative">
                                    <input 
                                        type="text" 
                                        placeholder="Search jobs..." 
                                        className="w-full p-2 pl-10 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        value={searchTerm}
                                        onChange={(e) => setSearchTerm(e.target.value)}
                                    />
                                    <i className="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                                </div>
                            </div>
                            <div>
                                <select 
                                    className="w-full p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    value={statusFilter}
                                    onChange={(e) => setStatusFilter(e.target.value)}
                                >
                                    <option value="All">All Statuses</option>
                                    <option value="Pending">Pending</option>
                                    <option value="In Progress">In Progress</option>
                                    <option value="Completed">Completed</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div className="card overflow-x-auto">
                        <table className="min-w-full">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Job ID</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Customer</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Phone</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Device</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Created</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                                </tr>
                            </thead>
                            <tbody className="bg-white divide-y divide-gray-200">
                                {filteredJobs.map(job => (
                                    <tr key={job._id} className="hover:bg-gray-50">
                                        <td className="px-6 py-4 whitespace-nowrap font-medium">{job.jobId}</td>
                                        <td className="px-6 py-4 whitespace-nowrap font-medium">{job.customerName}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{job.customerPhone || 'N/A'}</td>
                                        <td className="px-6 py-4 whitespace-nowrap">
                                            <div>
                                                <p className="font-medium">{job.deviceBrand} {job.deviceModel}</p>
                                                <p className="text-sm text-gray-500">{job.deviceType}</p>
                                            </div>
                                        </td>
                                        <td className="px-6 py-4 whitespace-nowrap">
                                            <span className={`status-badge ${getStatusClass(job.status)}`}>
                                                {job.status === 'Pending' && <i className="fas fa-clock"></i>}
                                                {job.status === 'In Progress' && <i className="fas fa-spinner"></i>}
                                                {job.status === 'Completed' && <i className="fas fa-check"></i>}
                                                {job.status}
                                            </span>
                                        </td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                            {formatDate(job.createdAt)}
                                        </td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                            <div className="flex items-center space-x-2">
                                                <button onClick={() => handleEdit(job)} className="text-blue-600 hover:text-blue-900 p-1 rounded-full hover:bg-blue-50" title="Edit">
                                                    <i className="fas fa-edit"></i>
                                                </button>
                                                {job.customerPhone && (
                                                    <a href={`https://wa.me/${formatWhatsAppNumber(job.customerPhone)}`} target="_blank" rel="noopener noreferrer" className="text-green-600 hover:text-green-900 p-1 rounded-full hover:bg-green-50" title="Chat on WhatsApp">
                                                        <i className="fab fa-whatsapp"></i>
                                                    </a>
                                                )}
                                                {job.status !== 'Completed' && (
                                                    <button onClick={() => handleCompleteJob(job._id)} className="text-green-600 hover:text-green-900 p-1 rounded-full hover:bg-green-50" title="Complete">
                                                        <i className="fas fa-check-circle"></i>
                                                    </button>
                                                )}
                                                <button onClick={() => deleteItem(job._id)} className="text-red-600 hover:text-red-900 p-1 rounded-full hover:bg-red-50" title="Delete">
                                                    <i className="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                    
                    {filteredJobs.length === 0 && !loading && (
                        <div className="text-center py-12">
                            <i className="fas fa-inbox text-4xl text-gray-300 mb-3"></i>
                            <p className="text-gray-500">No jobs found</p>
                        </div>
                    )}
                    
                    {isModalOpen && (
                        <JobModal 
                            job={editingJob} 
                            onClose={() => setIsModalOpen(false)} 
                            onSave={handleSave} 
                            customers={customers || []} 
                            inventory={inventory || []}
                            technicians={users || []}
                            onSendNote={handleSendNote}
                        />
                    )}
                </div>
            );
        };

        const JobModal = ({ job, onClose, onSave, customers, inventory, technicians, onSendNote }) => {
            const [formData, setFormData] = useState(job || {
                customerName: '', customerPhone: '', customerEmail: '', deviceType: '', deviceBrand: '', deviceModel: '',
                problemDescription: '', status: 'Pending', assignedTo: '', estimatedCost: 0, actualCost: 0, parts: []
            });
            const [selectedParts, setSelectedParts] = useState(job ? job.parts || [] : []);
            const [activeTab, setActiveTab] = useState('details');
            const [newNote, setNewNote] = useState('');

            const handleChange = (e) => setFormData({ ...formData, [e.target.name]: e.target.value });
            
            const handleSendWhatsAppCopy = (jobData) => {
                if (!jobData.customerPhone) {
                    alert('Please enter a customer phone number to send a copy.');
                    return;
                }

                const isUpdate = !!job;
                const title = isUpdate ? '*PC Garage Pro - Job Update*' : '*PC Garage Pro - New Job Details*';
                const totalCost = jobData.actualCost != null ? jobData.actualCost.toFixed(2) : (jobData.estimatedCost || 0).toFixed(2);
                const closingMessage = isUpdate ?
                    `Your job details have been updated. Thank you!` :
                    `We will keep you updated on the status of your repair. Thank you!`;

                const message = `${title}\n\n` +
                    `Job ID: ${jobData.jobId || 'N/A'}\n` +
                    `Customer: ${jobData.customerName || 'N/A'}\n` +
                    `Device: ${jobData.deviceType || 'N/A'} - ${jobData.deviceBrand || ''} ${jobData.deviceModel || ''}\n` +
                    `Problem: ${jobData.problemDescription || 'N/A'}\n` +
                    `Status: ${jobData.status || 'Pending'}\n` +
                    `Total Estimated Cost: Rs${totalCost}\n\n` +
                    `${closingMessage}`;

                const encodedMessage = encodeURIComponent(message);
                window.open(`https://wa.me/${formatWhatsAppNumber(jobData.customerPhone)}?text=${encodedMessage}`, '_blank');
            };

            const handleSubmit = async (e, sendCopy = false) => { 
                e.preventDefault(); 
                try {
                    const savedJob = await onSave({
                        ...formData, 
                        parts: selectedParts,
                        actualCost: selectedParts.reduce((total, part) => total + (part.cost * part.quantity), 0) + (parseFloat(formData.estimatedCost) || 0)
                    }); 

                    if (savedJob) {
                        if (sendCopy) {
                            handleSendWhatsAppCopy(savedJob);
                        }
                        onClose();
                    } else {
                        alert('An error occurred while saving the job.');
                    }
                } catch (error) {
                    alert(`Error: ${error.message}`);
                }
            };
            
            const addPart = (part) => {
                if (!part || selectedParts.find(p => p._id === part._id)) return;
                setSelectedParts([...selectedParts, { ...part, quantity: 1 }]);
            };
            
            const removePart = (partId) => setSelectedParts(selectedParts.filter(p => p._id !== partId));
            
            const updatePartQuantity = (partId, quantity) => {
                const numQuantity = parseInt(quantity, 10);
                if (isNaN(numQuantity) || numQuantity < 1) return;
                setSelectedParts(selectedParts.map(p => p._id === partId ? { ...p, quantity: numQuantity } : p));
            };
            
            const addNote = () => {
                if (!newNote.trim()) return;
                
                const note = {
                    text: newNote,
                    createdBy: 'Current User', // In a real app, this would be the logged in user's name
                    createdAt: new Date()
                };
                
                setFormData({
                    ...formData,
                    notes: [...(formData.notes || []), note]
                });
                
                setNewNote('');
            };
            
            const totalPartsCost = selectedParts.reduce((total, part) => total + (part.cost * part.quantity), 0);
            const totalCost = totalPartsCost + (parseFloat(formData.estimatedCost) || 0);

            return (
                <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col">
                        <div className="px-6 py-4 border-b flex justify-between items-center">
                            <h3 className="text-lg font-semibold">{job ? 'Edit Job' : 'Create New Job'}</h3>
                            <button onClick={onClose} className="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                        </div>
                        
                        <div className="border-b">
                            <nav className="flex -mb-px">
                                <button
                                    onClick={() => setActiveTab('details')}
                                    className={`py-3 px-6 text-sm font-medium ${activeTab === 'details' ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-500 hover:text-gray-700'}`}
                                >
                                    Details
                                </button>
                                <button
                                    onClick={() => setActiveTab('parts')}
                                    className={`py-3 px-6 text-sm font-medium ${activeTab === 'parts' ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-500 hover:text-gray-700'}`}
                                >
                                    Parts & Costs
                                </button>
                                <button
                                    onClick={() => setActiveTab('notes')}
                                    className={`py-3 px-6 text-sm font-medium ${activeTab === 'notes' ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-500 hover:text-gray-700'}`}
                                >
                                    Notes
                                </button>
                            </nav>
                        </div>
                        
                        <form onSubmit={handleSubmit} className="flex-grow overflow-y-auto">
                            {activeTab === 'details' && (
                                <div className="p-6 space-y-4">
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-sm font-bold mb-2">Customer Name *</label>
                                            <input 
                                                type="text" 
                                                name="customerName" 
                                                value={formData.customerName} 
                                                onChange={handleChange} 
                                                className="w-full p-2 border rounded" 
                                                required 
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-bold mb-2">Customer Phone</label>
                                            <input 
                                                type="text" 
                                                name="customerPhone" 
                                                value={formData.customerPhone} 
                                                onChange={handleChange} 
                                                className="w-full p-2 border rounded" 
                                            />
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label className="block text-sm font-bold mb-2">Customer Email</label>
                                        <input 
                                            type="email" 
                                            name="customerEmail" 
                                            value={formData.customerEmail} 
                                            onChange={handleChange} 
                                            className="w-full p-2 border rounded" 
                                        />
                                    </div>
                                    
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div>
                                            <label className="block text-sm font-bold mb-2">Device Type *</label>
                                            <select 
                                                name="deviceType" 
                                                value={formData.deviceType} 
                                                onChange={handleChange} 
                                                className="w-full p-2 border rounded" 
                                                required
                                            >
                                                <option value="">Select Type</option>
                                                <option value="Laptop">Laptop</option>
                                                <option value="Desktop">Desktop</option>
                                                <option value="Tablet">Tablet</option>
                                                <option value="Smartphone">Smartphone</option>
                                                <option value="Monitor">Monitor</option>
                                                <option value="Printer">Printer</option>
                                                <option value="Other">Other</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-sm font-bold mb-2">Device Brand</label>
                                            <input 
                                                type="text" 
                                                name="deviceBrand" 
                                                value={formData.deviceBrand} 
                                                onChange={handleChange} 
                                                className="w-full p-2 border rounded" 
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-bold mb-2">Device Model *</label>
                                            <input 
                                                type="text" 
                                                name="deviceModel" 
                                                value={formData.deviceModel} 
                                                onChange={handleChange} 
                                                className="w-full p-2 border rounded" 
                                                required 
                                            />
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label className="block text-sm font-bold mb-2">Problem Description *</label>
                                        <textarea 
                                            name="problemDescription" 
                                            value={formData.problemDescription} 
                                            onChange={handleChange} 
                                            rows="3" 
                                            className="w-full p-2 border rounded" 
                                            required
                                        ></textarea>
                                    </div>
                                    
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-sm font-bold mb-2">Status</label>
                                            <select 
                                                name="status" 
                                                value={formData.status} 
                                                onChange={handleChange} 
                                                className="w-full p-2 border rounded"
                                            >
                                                <option value="Pending">Pending</option>
                                                <option value="In Progress">In Progress</option>
                                                <option value="Completed">Completed</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-sm font-bold mb-2">Assigned To</label>
                                            <select 
                                                name="assignedTo" 
                                                value={formData.assignedTo} 
                                                onChange={handleChange} 
                                                className="w-full p-2 border rounded"
                                            >
                                                <option value="">Unassigned</option>
                                                {technicians.map(tech => (
                                                    <option key={tech._id} value={tech._id}>{tech.name}</option>
                                                ))}
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            )}
                            
                            {activeTab === 'parts' && (
                                <div className="p-6 space-y-6">
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div>
                                            <label className="block text-sm font-bold mb-2">Labor Cost (Rs)</label>
                                            <input 
                                                type="number" 
                                                name="estimatedCost" 
                                                value={formData.estimatedCost} 
                                                onChange={handleChange} 
                                                className="w-full p-2 border rounded" 
                                                min="0" 
                                                step="0.01" 
                                            />
                                        </div>
                                        
                                        <div className="bg-gray-50 p-4 rounded-lg">
                                            <div className="flex justify-between items-center mb-2">
                                                <span className="font-medium">Parts Cost:</span>
                                                <span>Rs{totalPartsCost.toFixed(2)}</span>
                                            </div>
                                            <div className="flex justify-between items-center mb-2">
                                                <span className="font-medium">Labor Cost:</span>
                                                <span>Rs{(parseFloat(formData.estimatedCost) || 0).toFixed(2)}</span>
                                            </div>
                                            <hr className="my-2" />
                                            <div className="flex justify-between items-center font-bold">
                                                <span>Total Cost:</span>
                                                <span>Rs{totalCost.toFixed(2)}</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label className="block text-sm font-bold mb-2">Parts Used</label>
                                        <div className="border rounded p-3">
                                            <div className="space-y-2 mb-3">
                                                {selectedParts.map(part => (
                                                    <div key={part._id} className="flex justify-between items-center p-2 bg-gray-50 rounded">
                                                        <div>
                                                            <p className="font-medium">{part.name}</p>
                                                            <p className="text-xs text-gray-500">Part #: {part.partNumber} | Rs{part.cost} each</p>
                                                        </div>
                                                        <div className="flex items-center gap-2">
                                                            <input 
                                                                type="number" 
                                                                min="1" 
                                                                max={part.stock} 
                                                                value={part.quantity} 
                                                                onChange={(e) => updatePartQuantity(part._id, e.target.value)} 
                                                                className="w-16 p-1 border rounded text-center" 
                                                            />
                                                            <button 
                                                                type="button" 
                                                                onClick={() => removePart(part._id)} 
                                                                className="text-red-600 p-1 hover:bg-red-100 rounded-full"
                                                            >
                                                                <i className="fas fa-times"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                            
                                            {selectedParts.length === 0 && (
                                                <div className="text-center py-4 text-gray-500">
                                                    <i className="fas fa-box-open text-2xl mb-2"></i>
                                                    <p>No parts added</p>
                                                </div>
                                            )}
                                            
                                            <select 
                                                className="w-full p-2 border rounded" 
                                                onChange={(e) => { 
                                                    if (e.target.value) { 
                                                        const part = inventory.find(p => p._id === e.target.value); 
                                                        addPart(part); 
                                                        e.target.value = ''; 
                                                    }
                                                }}
                                            >
                                                <option value="">-- Add Part from Inventory --</option>
                                                {inventory.filter(p => p.stock > 0).map(part => (
                                                    <option key={part._id} value={part._id}>
                                                        {part.name} (Stock: {part.stock}) - Rs{part.cost}
                                                    </option>
                                                ))}
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            )}
                            
                            {activeTab === 'notes' && (
                                <div className="p-6 space-y-4">
                                    <div>
                                        <label className="block text-sm font-bold mb-2">Add Note</label>
                                        <div className="flex gap-2">
                                            <input 
                                                type="text" 
                                                value={newNote} 
                                                onChange={(e) => setNewNote(e.target.value)} 
                                                className="flex-1 p-2 border rounded" 
                                                placeholder="Add a note about this job..." 
                                            />
                                            <button 
                                                type="button" 
                                                onClick={addNote} 
                                                className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
                                            >
                                                Add
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div className="space-y-3">
                                        {(formData.notes || []).map((note, index) => (
                                            <div key={index} className="p-3 bg-gray-50 rounded-lg flex justify-between items-center">
                                                <div>
                                                    <p className="text-sm">{note.text}</p>
                                                    <div className="flex justify-between items-center mt-2 text-xs text-gray-500">
                                                        <span>By: {note.createdBy}</span>
                                                        <span>{formatDateTime(note.createdAt)}</span>
                                                    </div>
                                                </div>
                                                {job && job._id && formData.customerPhone && onSendNote && (
                                                    <button
                                                        type="button"
                                                        onClick={() => onSendNote(job._id, note.text, formData.customerPhone)}
                                                        className="ml-4 px-3 py-1 bg-green-500 text-white rounded hover:bg-green-600 text-sm flex items-center gap-2"
                                                        title="Send note to customer via SMS"
                                                    >
                                                        <i className="fas fa-paper-plane"></i>
                                                        Send
                                                    </button>
                                                )}
                                            </div>
                                        ))}
                                        
                                        {(formData.notes || []).length === 0 && (
                                            <div className="text-center py-8 text-gray-500">
                                                <i className="fas fa-sticky-note text-2xl mb-2"></i>
                                                <p>No notes yet</p>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}
                        </form>
                        
                        <div className="px-6 py-4 border-t flex justify-end">
                            <button type="button" onClick={onClose} className="mr-auto px-4 py-2 text-gray-700 rounded border hover:bg-gray-100">Cancel</button>
                            {!job && (
                                <button type="button" onClick={(e) => handleSubmit(e, true)} className="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 flex items-center" title="Save the job and send a copy to the customer via WhatsApp">
                                    <i className="fab fa-whatsapp mr-2"></i> Save & Send
                                </button>
                            )}
                            {job && (
                                <button type="button" onClick={(e) => handleSubmit(e, true)} className="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 flex items-center" title="Update the job and send a copy to the customer via WhatsApp">
                                    <i className="fab fa-whatsapp mr-2"></i> Update & Send
                                </button>
                            )}
                            <button type="button" onClick={(e) => handleSubmit(e, false)} className="ml-4 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                                {job ? 'Update Job' : 'Create Job'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const Customers = () => {
            const { data: customers, loading, error, addItem, updateItem, deleteItem } = useApi('customers');
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingCustomer, setEditingCustomer] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');

            const handleCreate = () => { setEditingCustomer(null); setIsModalOpen(true); };
            const handleEdit = (customer) => { setEditingCustomer(customer); setIsModalOpen(true); };
            const handleSave = async (customerData) => {
                if (editingCustomer) {
                    await updateItem(editingCustomer._id, customerData);
                } else {
                    await addItem(customerData);
                }
                setIsModalOpen(false);
            };

            const filteredCustomers = customers ? customers.filter(customer => 
                customer.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                (customer.email && customer.email.toLowerCase().includes(searchTerm.toLowerCase())) ||
                (customer.phone && customer.phone.includes(searchTerm))
            ) : [];

            if (loading) return <div className="text-center p-8">Loading Customers...</div>;
            if (error) return <div className="text-center p-8 text-red-500">Error loading customers.</div>;

            return (
                <div className="fade-in">
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-2xl font-semibold">Customers</h2>
                        <button onClick={handleCreate} className="btn-primary flex items-center gap-2"><i className="fas fa-plus"></i> New Customer</button>
                    </div>
                    
                    <div className="card p-4 mb-6">
                        <div className="relative">
                            <input 
                                type="text" 
                                placeholder="Search customers..." 
                                className="w-full p-2 pl-10 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                value={searchTerm}
                                onChange={(e) => setSearchTerm(e.target.value)}
                            />
                            <i className="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                        </div>
                    </div>
                    
                    <div className="card overflow-x-auto">
                        <table className="min-w-full">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Phone</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Address</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Joined</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                                </tr>
                            </thead>
                            <tbody className="bg-white divide-y divide-gray-200">
                                {filteredCustomers.map(customer => (
                                    <tr key={customer._id} className="hover:bg-gray-50">
                                        <td className="px-6 py-4 whitespace-nowrap font-medium">{customer.name}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{customer.email || 'N/A'}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{customer.phone || 'N/A'}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{customer.address || 'N/A'}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{formatDate(customer.createdAt)}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                            <div className="flex items-center space-x-2">
                                                <button onClick={() => handleEdit(customer)} className="text-blue-600 hover:text-blue-900 p-1 rounded-full hover:bg-blue-50" title="Edit">
                                                    <i className="fas fa-edit"></i>
                                                </button>
                                                <button onClick={() => deleteItem(customer._id)} className="text-red-600 hover:text-red-900 p-1 rounded-full hover:bg-red-50" title="Delete">
                                                    <i className="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                    
                    {filteredCustomers.length === 0 && !loading && (
                        <div className="text-center py-12">
                            <i className="fas fa-users text-4xl text-gray-300 mb-3"></i>
                            <p className="text-gray-500">No customers found</p>
                        </div>
                    )}
                    
                    {isModalOpen && (
                        <CustomerModal 
                            customer={editingCustomer} 
                            onClose={() => setIsModalOpen(false)} 
                            onSave={handleSave} 
                        />
                    )}
                </div>
            );
        };

        const CustomerModal = ({ customer, onClose, onSave }) => {
            const [formData, setFormData] = useState(customer || {
                name: '', email: '', phone: '', address: ''
            });

            const handleChange = (e) => setFormData({ ...formData, [e.target.name]: e.target.value });
            const handleSubmit = (e) => { e.preventDefault(); onSave(formData); };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-lg shadow-xl w-full max-w-md">
                        <div className="px-6 py-4 border-b flex justify-between items-center">
                            <h3 className="text-lg font-semibold">{customer ? 'Edit Customer' : 'Create New Customer'}</h3>
                            <button onClick={onClose} className="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                        </div>
                        
                        <form onSubmit={handleSubmit} className="p-6 space-y-4">
                            <div>
                                <label className="block text-sm font-bold mb-2">Name *</label>
                                <input 
                                    type="text" 
                                    name="name" 
                                    value={formData.name} 
                                    onChange={handleChange} 
                                    className="w-full p-2 border rounded" 
                                    required 
                                />
                            </div>
                            
                            <div>
                                <label className="block text-sm font-bold mb-2">Email</label>
                                <input 
                                    type="email" 
                                    name="email" 
                                    value={formData.email} 
                                    onChange={handleChange} 
                                    className="w-full p-2 border rounded" 
                                />
                            </div>
                            
                            <div>
                                <label className="block text-sm font-bold mb-2">Phone</label>
                                <input 
                                    type="text" 
                                    name="phone" 
                                    value={formData.phone} 
                                    onChange={handleChange} 
                                    className="w-full p-2 border rounded" 
                                />
                            </div>
                            
                            <div>
                                <label className="block text-sm font-bold mb-2">Address</label>
                                <textarea 
                                    name="address" 
                                    value={formData.address} 
                                    onChange={handleChange} 
                                    rows="3" 
                                    className="w-full p-2 border rounded" 
                                ></textarea>
                            </div>
                        </form>
                        
                        <div className="px-6 py-4 border-t flex justify-end">
                            <button type="button" onClick={onClose} className="mr-3 px-4 py-2 text-gray-700 rounded border hover:bg-gray-100">Cancel</button>
                            <button type="button" onClick={handleSubmit} className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                                {customer ? 'Update Customer' : 'Create Customer'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };
        
        const Inventory = () => {
            const { data: inventory, loading, error, addItem, updateItem, deleteItem } = useApi('inventory');
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingItem, setEditingItem] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const [lowStockOnly, setLowStockOnly] = useState(false);

            const handleCreate = () => { setEditingItem(null); setIsModalOpen(true); };
            const handleEdit = (item) => { setEditingItem(item); setIsModalOpen(true); };
            const handleSave = async (itemData) => {
                if (editingItem) {
                    await updateItem(editingItem._id, itemData);
                } else {
                    await addItem(itemData);
                }
                setIsModalOpen(false);
            };

            const filteredInventory = inventory ? inventory.filter(item => {
                const matchesSearch = item.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                                    item.partNumber.toLowerCase().includes(searchTerm.toLowerCase()) ||
                                    (item.category && item.category.toLowerCase().includes(searchTerm.toLowerCase()));
                
                const matchesStock = !lowStockOnly || item.stock <= item.minStock;
                
                return matchesSearch && matchesStock;
            }) : [];

            if (loading) return <div className="text-center p-8">Loading Inventory...</div>;
            if (error) return <div className="text-center p-8 text-red-500">Error loading inventory.</div>;

            return (
                <div className="fade-in">
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-2xl font-semibold">Inventory</h2>
                        <button onClick={handleCreate} className="btn-primary flex items-center gap-2"><i className="fas fa-plus"></i> New Part</button>
                    </div>
                    
                    <div className="card p-4 mb-6">
                        <div className="flex flex-col md:flex-row gap-4">
                            <div className="flex-1">
                                <div className="relative">
                                    <input 
                                        type="text" 
                                        placeholder="Search inventory..." 
                                        className="w-full p-2 pl-10 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        value={searchTerm}
                                        onChange={(e) => setSearchTerm(e.target.value)}
                                    />
                                    <i className="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                                </div>
                            </div>
                            <div className="flex items-center">
                                <label className="flex items-center cursor-pointer">
                                    <div className="relative">
                                        <input 
                                            type="checkbox" 
                                            className="sr-only" 
                                            checked={lowStockOnly}
                                            onChange={() => setLowStockOnly(!lowStockOnly)}
                                        />
                                        <div className={`block w-14 h-8 rounded-full ${lowStockOnly ? 'bg-blue-400' : 'bg-gray-400'}`}></div>
                                        <div className={`dot absolute left-1 top-1 bg-white w-6 h-6 rounded-full transition transform ${lowStockOnly ? 'translate-x-6' : ''}`}></div>
                                    </div>
                                    <div className="ml-3 text-gray-700 font-medium">Show low stock only</div>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        {filteredInventory.map(item => (
                            <div key={item._id} className="card p-6 hover:shadow-md transition-shadow">
                                <div className="flex items-start justify-between mb-4">
                                    <div>
                                        <h3 className="text-lg font-semibold">{item.name}</h3>
                                        <p className="text-gray-600">{item.partNumber}</p>
                                    </div>
                                    <div className="flex items-center space-x-2">
                                        <button onClick={() => handleEdit(item)} className="text-blue-600 hover:text-blue-900 p-1 rounded-full hover:bg-blue-50">
                                            <i className="fas fa-edit"></i>
                                        </button>
                                        <button onClick={() => deleteItem(item._id)} className="text-red-600 hover:text-red-900 p-1 rounded-full hover:bg-red-50">
                                            <i className="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <div className="space-y-2">
                                    <div className="flex justify-between items-center">
                                        <span className="text-gray-600">Stock Level:</span>
                                        <span className={`font-semibold ${item.stock <= item.minStock ? 'text-red-600' : 'text-green-600'}`}>
                                            {item.stock} {item.stock <= item.minStock && <i className="fas fa-exclamation-triangle"></i>}
                                        </span>
                                    </div>
                                    
                                    <div className="flex justify-between items-center">
                                        <span className="text-gray-600">Cost:</span>
                                        <span className="font-semibold">Rs{item.cost?.toFixed(2) || '0.00'}</span>
                                    </div>
                                    
                                    {item.category && (
                                        <div className="flex justify-between items-center">
                                            <span className="text-gray-600">Category:</span>
                                            <span className="font-semibold">{item.category}</span>
                                        </div>
                                    )}
                                    
                                    {item.supplier && (
                                        <div className="flex justify-between items-center">
                                            <span className="text-gray-600">Supplier:</span>
                                            <span className="font-semibold">{item.supplier}</span>
                                        </div>
                                    )}
                                    
                                    <div className="pt-2">
                                        <div className="bg-gray-200 rounded-full h-2.5">
                                            <div 
                                                className={`h-2.5 rounded-full ${item.stock <= item.minStock ? 'bg-red-600' : 'bg-green-600'}`} 
                                                style={{ width: `${Math.min(100, (item.stock / (item.minStock * 3)) * 100)}%` }}
                                            ></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                    
                    {filteredInventory.length === 0 && !loading && (
                        <div className="text-center py-12">
                            <i className="fas fa-box-open text-4xl text-gray-300 mb-3"></i>
                            <p className="text-gray-500">No inventory items found</p>
                        </div>
                    )}
                    
                    {isModalOpen && (
                        <InventoryModal 
                            item={editingItem} 
                            onClose={() => setIsModalOpen(false)} 
                            onSave={handleSave} 
                        />
                    )}
                </div>
            );
        };

        const InventoryModal = ({ item, onClose, onSave }) => {
            const [formData, setFormData] = useState(item || { 
                name: '', partNumber: '', stock: 0, cost: 0, minStock: 5, category: '', supplier: '' 
            });

            const handleChange = (e) => setFormData({ ...formData, [e.target.name]: e.target.value });
            const handleSubmit = (e) => { e.preventDefault(); onSave(formData); };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-lg shadow-xl w-full max-w-md">
                        <div className="px-6 py-4 border-b flex justify-between items-center">
                            <h3 className="text-lg font-semibold">{item ? 'Edit Part' : 'Create New Part'}</h3>
                            <button onClick={onClose} className="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                        </div>
                        
                        <form onSubmit={handleSubmit} className="p-6 space-y-4">
                            <div>
                                <label className="block text-sm font-bold mb-2">Part Name *</label>
                                <input 
                                    type="text" 
                                    name="name" 
                                    value={formData.name} 
                                    onChange={handleChange} 
                                    className="w-full p-2 border rounded" 
                                    required 
                                />
                            </div>
                            
                            <div>
                                <label className="block text-sm font-bold mb-2">Part Number *</label>
                                <input 
                                    type="text" 
                                    name="partNumber" 
                                    value={formData.partNumber} 
                                    onChange={handleChange} 
                                    className="w-full p-2 border rounded" 
                                    required 
                                />
                            </div>
                            
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm font-bold mb-2">Stock *</label>
                                    <input 
                                        type="number" 
                                        name="stock" 
                                        value={formData.stock} 
                                        onChange={handleChange} 
                                        className="w-full p-2 border rounded" 
                                        required 
                                        min="0" 
                                    />
                                </div>
                                
                                <div>
                                    <label className="block text-sm font-bold mb-2">Cost (Rs)</label>
                                    <input 
                                        type="number" 
                                        name="cost" 
                                        value={formData.cost} 
                                        onChange={handleChange} 
                                        className="w-full p-2 border rounded" 
                                        min="0" 
                                        step="0.01" 
                                    />
                                </div>
                            </div>
                            
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm font-bold mb-2">Min Stock</label>
                                    <input 
                                        type="number" 
                                        name="minStock" 
                                        value={formData.minStock} 
                                        onChange={handleChange} 
                                        className="w-full p-2 border rounded" 
                                        min="1" 
                                    />
                                </div>
                                
                                <div>
                                    <label className="block text-sm font-bold mb-2">Category</label>
                                    <select 
                                        name="category" 
                                        value={formData.category} 
                                        onChange={handleChange} 
                                        className="w-full p-2 border rounded"
                                    >
                                        <option value="">Select Category</option>
                                        <option value="Component">Component</option>
                                        <option value="Peripheral">Peripheral</option>
                                        <option value="Accessory">Accessory</option>
                                        <option value="Tool">Tool</option>
                                        <option value="Consumable">Consumable</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div>
                                <label className="block text-sm font-bold mb-2">Supplier</label>
                                <input 
                                    type="text" 
                                    name="supplier" 
                                    value={formData.supplier} 
                                    onChange={handleChange} 
                                    className="w-full p-2 border rounded" 
                                />
                            </div>
                        </form>
                        
                        <div className="px-6 py-4 border-t flex justify-end">
                            <button type="button" onClick={onClose} className="mr-3 px-4 py-2 text-gray-700 rounded border hover:bg-gray-100">Cancel</button>
                            <button type="button" onClick={handleSubmit} className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                                {item ? 'Update Part' : 'Create Part'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };
        
        const UserProfile = () => {
            const { user } = useAuth();
            return (
                <div className="card p-6">
                    <h3 className="text-lg font-semibold mb-4">User Profile</h3>
                    <div className="space-y-4">
                        <div>
                            <label className="block text-sm font-bold text-gray-700">Name</label>
                            <input type="text" value={user.name} disabled className="mt-1 block w-full p-2 border border-gray-300 rounded-md bg-gray-100" />
                        </div>
                        <div>
                            <label className="block text-sm font-bold text-gray-700">Email</label>
                            <input type="email" value={user.email} disabled className="mt-1 block w-full p-2 border border-gray-300 rounded-md bg-gray-100" />
                        </div>
                        <div>
                            <label className="block text-sm font-bold text-gray-700">Role</label>
                            <input type="text" value={user.role} disabled className="mt-1 block w-full p-2 border border-gray-300 rounded-md bg-gray-100" />
                        </div>
                    </div>
                </div>
            );
        };

        const Technicians = () => {
            const { data: technicians, loading, error, addItem, updateItem, deleteItem } = useApi('users');
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingTechnician, setEditingTechnician] = useState(null);

            const handleCreate = () => { setEditingTechnician(null); setIsModalOpen(true); };
            const handleEdit = (technician) => { setEditingTechnician(technician); setIsModalOpen(true); };
            const handleSave = async (technicianData) => {
                if (editingTechnician) {
                    await updateItem(editingTechnician._id, technicianData);
                } else {
                    await addItem(technicianData);
                }
                setIsModalOpen(false);
            };

            if (loading) return <div className="text-center p-8">Loading Technicians...</div>;
            if (error) return <div className="text-center p-8 text-red-500">Error loading technicians.</div>;

            return (
                <div className="card p-6">
                    <div className="flex justify-between items-center mb-6">
                        <h3 className="text-lg font-semibold">Manage Technicians</h3>
                        <button onClick={handleCreate} className="btn-primary flex items-center gap-2">
                            <i className="fas fa-plus"></i> Add Technician
                        </button>
                    </div>
                    
                    <div className="overflow-x-auto">
                        <table className="min-w-full divide-y divide-gray-200">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Role</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Joined</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                                </tr>
                            </thead>
                            <tbody className="bg-white divide-y divide-gray-200">
                                {technicians.map(tech => (
                                    <tr key={tech._id}>
                                        <td className="px-6 py-4 whitespace-nowrap">{tech.name}</td>
                                        <td className="px-6 py-4 whitespace-nowrap">{tech.email}</td>
                                        <td className="px-6 py-4 whitespace-nowrap capitalize">{tech.role}</td>
                                        <td className="px-6 py-4 whitespace-nowrap">{formatDate(tech.createdAt)}</td>
                                        <td className="px-6 py-4 whitespace-nowrap">
                                            <div className="flex items-center space-x-2">
                                                <button onClick={() => handleEdit(tech)} className="text-blue-600 hover:text-blue-900 p-1 rounded-full hover:bg-blue-50">
                                                    <i className="fas fa-edit"></i>
                                                </button>
                                                <button onClick={() => deleteItem(tech._id)} className="text-red-600 hover:text-red-900 p-1 rounded-full hover:bg-red-50">
                                                    <i className="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                    
                    {technicians.length === 0 && !loading && (
                        <div className="text-center py-12">
                            <i className="fas fa-user-cog text-4xl text-gray-300 mb-3"></i>
                            <p className="text-gray-500">No technicians found</p>
                        </div>
                    )}
                    
                    {isModalOpen && (
                        <TechnicianModal 
                            technician={editingTechnician} 
                            onClose={() => setIsModalOpen(false)} 
                            onSave={handleSave} 
                        />
                    )}
                </div>
            );
        };

        const TechnicianModal = ({ technician, onClose, onSave }) => {
            const [formData, setFormData] = useState(technician || {
                name: '', email: '', password: '', role: 'technician'
            });
            const [confirmPassword, setConfirmPassword] = useState('');
            const [passwordError, setPasswordError] = useState('');

            const handleChange = (e) => setFormData({ ...formData, [e.target.name]: e.target.value });
            
            const handleSubmit = (e) => { 
                e.preventDefault();
                
                if (!technician && formData.password !== confirmPassword) {
                    setPasswordError('Passwords do not match');
                    return;
                }
                
                setPasswordError('');
                onSave(formData); 
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-lg shadow-xl w-full max-w-md">
                        <div className="px-6 py-4 border-b flex justify-between items-center">
                            <h3 className="text-lg font-semibold">{technician ? 'Edit Technician' : 'Create New Technician'}</h3>
                            <button onClick={onClose} className="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                        </div>
                        
                        <form onSubmit={handleSubmit} className="p-6 space-y-4">
                            <div>
                                <label className="block text-sm font-bold mb-2">Name *</label>
                                <input 
                                    type="text" 
                                    name="name" 
                                    value={formData.name} 
                                    onChange={handleChange} 
                                    className="w-full p-2 border rounded" 
                                    required 
                                />
                            </div>
                            
                            <div>
                                <label className="block text-sm font-bold mb-2">Email *</label>
                                <input 
                                    type="email" 
                                    name="email" 
                                    value={formData.email} 
                                    onChange={handleChange} 
                                    className="w-full p-2 border rounded" 
                                    required 
                                />
                            </div>
                            
                            {!technician && (
                                <>
                                    <div>
                                        <label className="block text-sm font-bold mb-2">Password *</label>
                                        <input 
                                            type="password" 
                                            name="password" 
                                            value={formData.password} 
                                            onChange={handleChange} 
                                            className="w-full p-2 border rounded" 
                                            required 
                                        />
                                    </div>
                                    
                                    <div>
                                        <label className="block text-sm font-bold mb-2">Confirm Password *</label>
                                        <input 
                                            type="password" 
                                            value={confirmPassword} 
                                            onChange={(e) => setConfirmPassword(e.target.value)} 
                                            className="w-full p-2 border rounded" 
                                            required 
                                        />
                                        {passwordError && <p className="text-red-500 text-sm mt-1">{passwordError}</p>}
                                    </div>
                                </>
                            )}
                            
                            <div>
                                <label className="block text-sm font-bold mb-2">Role</label>
                                <select 
                                    name="role" 
                                    value={formData.role} 
                                    onChange={handleChange} 
                                    className="w-full p-2 border rounded"
                                >
                                    <option value="technician">Technician</option>
                                    <option value="admin">Admin</option>
                                </select>
                            </div>
                        </form>
                        
                        <div className="px-6 py-4 border-t flex justify-end">
                            <button type="button" onClick={onClose} className="mr-3 px-4 py-2 text-gray-700 rounded border hover:bg-gray-100">Cancel</button>
                            <button type="button" onClick={handleSubmit} className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                                {technician ? 'Update Technician' : 'Create Technician'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const BackupRestoreSettings = () => {
            const { token } = useAuth();
            const [settings, setSettings] = useState({ autoBackup: false, backupPath: '' });
            const [loading, setLoading] = useState(true);
            const [message, setMessage] = useState({ type: '', text: '' });
            const restoreInputRef = React.useRef(null);

            // Fetch settings on component mount
            useEffect(() => {
                const fetchSettings = async () => {
                    try {
                        const res = await fetch(`${API_URL}/settings/backup`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        if (res.ok) {
                            const data = await res.json();
                            setSettings(data);
                        } else {
                            console.error('Failed to fetch backup settings');
                            setMessage({ type: 'error', text: 'Could not load backup settings.' });
                        }
                    } catch (err) {
                        console.error(err);
                        setMessage({ type: 'error', text: 'Error connecting to server.' });
                    } finally {
                        setLoading(false);
                    }
                };
                fetchSettings();
            }, [token]);

            const handleSettingChange = (e) => {
                const { name, value, type, checked } = e.target;
                setSettings(prev => ({ ...prev, [name]: type === 'checkbox' ? checked : value }));
            };

            const handleSaveSettings = async () => {
                setMessage({ type: '', text: '' });
                try {
                    const res = await fetch(`${API_URL}/settings/backup`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(settings)
                    });
                    const result = await res.json();
                    if (res.ok) {
                        setMessage({ type: 'success', text: 'Settings saved successfully!' });
                    } else {
                        setMessage({ type: 'error', text: result.message || 'Failed to save settings.' });
                    }
                } catch (err) {
                    setMessage({ type: 'error', text: 'Error connecting to server.' });
                }
            };

            const handleBackupNow = async () => {
                setMessage({ type: '', text: '' });
                setMessage({ type: 'info', text: 'Backup in progress... Please wait.' });
                try {
                    const res = await fetch(`${API_URL}/backup/now`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const result = await res.json();
                    if (res.ok) {
                        setMessage({ type: 'success', text: result.message });
                    } else {
                        setMessage({ type: 'error', text: result.message || 'Backup failed.' });
                    }
                } catch (err) {
                    setMessage({ type: 'error', text: 'Error connecting to server.' });
                }
            };

            const handleRestore = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                setMessage({ type: '', text: '' });
                setMessage({ type: 'info', text: 'Restore in progress... This may take a few moments.' });

                const formData = new FormData();
                formData.append('backupFile', file);

                try {
                    const res = await fetch(`${API_URL}/backup/restore`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` },
                        body: formData
                    });
                    const result = await res.json();
                    if (res.ok) {
                        setMessage({ type: 'success', text: result.message });
                    } else {
                        setMessage({ type: 'error', text: result.message || 'Restore failed.' });
                    }
                } catch (err) {
                    setMessage({ type: 'error', text: 'Error connecting to server.' });
                } finally {
                    // Reset file input
                    if(restoreInputRef.current) {
                        restoreInputRef.current.value = "";
                    }
                }
            };

            if (loading) {
                return <div className="text-center p-8">Loading Settings...</div>;
            }

            return (
                <div className="card p-6 max-w-2xl mx-auto">
                    <h3 className="text-xl font-semibold mb-6">Database Backup & Restore</h3>

                    {message.text && (
                        <div className={`p-3 mb-4 rounded text-sm ${
                            message.type === 'success' ? 'bg-green-100 text-green-800' :
                            message.type === 'error' ? 'bg-red-100 text-red-800' :
                            'bg-blue-100 text-blue-800'
                        }`}>
                            {message.text}
                        </div>
                    )}

                    <div className="space-y-6">
                        {/* Manual Backup */}
                        <div className="p-4 border rounded-lg">
                            <h4 className="font-semibold mb-2">Manual Backup</h4>
                            <p className="text-sm text-gray-600 mb-4">Create an immediate backup of the entire database.</p>
                            <button onClick={handleBackupNow} className="btn-primary">
                                <i className="fas fa-download mr-2"></i>Backup Now
                            </button>
                        </div>

                        {/* Restore */}
                        <div className="p-4 border rounded-lg">
                            <h4 className="font-semibold mb-2">Restore from Backup</h4>
                            <p className="text-sm text-gray-600 mb-4">
                                <i className="fas fa-exclamation-triangle text-yellow-500 mr-2"></i>
                                Warning: Restoring will overwrite the current database. This action cannot be undone.
                            </p>
                            <input type="file" accept=".gz,.archive" onChange={handleRestore} className="hidden" ref={restoreInputRef} />
                            <button onClick={() => restoreInputRef.current.click()} className="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
                                <i className="fas fa-upload mr-2"></i>Choose File & Restore
                            </button>
                        </div>

                        {/* Auto Backup Settings */}
                        <div className="p-4 border rounded-lg">
                            <h4 className="font-semibold mb-2">Automatic Backup Settings</h4>
                            <div className="flex items-center justify-between mb-4">
                                <label htmlFor="autoBackup" className="text-sm font-medium text-gray-700">Enable Daily Auto-Backup</label>
                                <div className="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                                    <input 
                                        type="checkbox" 
                                        name="autoBackup" 
                                        id="autoBackup" 
                                        checked={settings.autoBackup}
                                        onChange={handleSettingChange}
                                        className="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"
                                    />
                                    <label htmlFor="autoBackup" className="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                                </div>
                            </div>
                            <div>
                                <label htmlFor="backupPath" className="block text-sm font-medium text-gray-700 mb-1">Backup Storage Path</label>
                                <input 
                                    type="text" 
                                    id="backupPath"
                                    name="backupPath"
                                    value={settings.backupPath}
                                    onChange={handleSettingChange}
                                    placeholder="e.g., C:\\Users\\YourUser\\Documents\\PCGarageBackups"
                                    className="w-full p-2 border rounded"
                                />
                                <p className="text-xs text-gray-500 mt-1">The path on the server where backups will be stored.</p>
                            </div>
                            <div className="mt-4 text-right">
                                <button onClick={handleSaveSettings} className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                                    Save Settings
                                </button>
                            </div>
                        </div>
                    </div>
                    <style>{`
                        .toggle-checkbox:checked {
                            right: 0;
                            border-color: #4361ee;
                        }
                        .toggle-checkbox:checked + .toggle-label {
                            background-color: #4361ee;
                        }
                    `}</style>
                </div>
            );
        };

        const Reports = () => {
            const [activeTab, setActiveTab] = useState('labor');

            const LaborCostReport = () => {
                const [period, setPeriod] = useState('monthly');
                // The endpoint will be dynamically created based on the period
                const { data: laborData, loading, error } = useApi(`reports/labor?period=${period}`);

                return (
                    <div className="card p-6">
                        <h3 className="text-lg font-semibold mb-4">Labor Cost Report</h3>
                        <div className="mb-4">
                            <button 
                                onClick={() => setPeriod('weekly')}
                                className={`px-4 py-2 rounded ${period === 'weekly' ? 'bg-blue-600 text-white' : 'bg-gray-200'}`}
                            >
                                Weekly
                            </button>
                            <button 
                                onClick={() => setPeriod('monthly')}
                                className={`ml-2 px-4 py-2 rounded ${period === 'monthly' ? 'bg-blue-600 text-white' : 'bg-gray-200'}`}
                            >
                                Monthly
                            </button>
                        </div>

                        {loading && <p>Loading report...</p>}
                        {error && <p className="text-red-500">Error loading report. Please ensure the backend supports this report.</p>}
                
                        {laborData && laborData.length > 0 && (
                            <div className="overflow-x-auto">
                                <table className="min-w-full divide-y divide-gray-200">
                                    <thead className="bg-gray-50">
                                        <tr>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">{period === 'weekly' ? 'Week' : 'Month'}</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Total Labor Cost</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Jobs Count</th>
                                        </tr>
                                    </thead>
                                    <tbody className="bg-white divide-y divide-gray-200">
                                        {laborData.map(item => (
                                            <tr key={item._id}>
                                                <td className="px-6 py-4 whitespace-nowrap">{item._id}</td>
                                                <td className="px-6 py-4 whitespace-nowrap">Rs{item.totalLabor.toFixed(2)}</td>
                                                <td className="px-6 py-4 whitespace-nowrap">{item.jobCount}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        )}
                        {laborData && laborData.length === 0 && !loading && <p>No data available for this period.</p>}
                    </div>
                );
            };

            const InventoryProfitReport = () => {
                return (
                    <div className="card p-6">
                        <h3 className="text-lg font-semibold mb-4">Inventory Item Profit</h3>
                        <div className="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4" role="alert">
                            <p className="font-bold">Feature in Development</p>
                            <p>
                                To accurately calculate profit, the system needs to track the selling price of each inventory part. 
                                This feature will be available once inventory items have both a 'cost' and a 'selling price'.
                            </p>
                        </div>
                        <div className="mt-6 text-center text-gray-400">
                            <i className="fas fa-chart-pie text-4xl mb-3"></i>
                            <p>Inventory profit report will be displayed here.</p>
                        </div>
                    </div>
                );
            };

            return (
                <div className="fade-in flex gap-6">
                    <div className="w-1/4">
                        <div className="card p-4">
                            <h3 className="font-semibold text-lg mb-4 px-2">Report Sections</h3>
                            <nav className="space-y-1">
                                <button onClick={() => setActiveTab('labor')} className={`w-full text-left flex items-center gap-3 px-4 py-2 rounded-md text-sm font-medium ${activeTab === 'labor' ? 'bg-blue-100 text-blue-700' : 'text-gray-600 hover:bg-gray-50 hover:text-gray-900'}`}>
                                    <i className="fas fa-dollar-sign w-5"></i>
                                    <span>Labor Cost</span>
                                </button>
                                <button onClick={() => setActiveTab('inventoryProfit')} className={`w-full text-left flex items-center gap-3 px-4 py-2 rounded-md text-sm font-medium ${activeTab === 'inventoryProfit' ? 'bg-blue-100 text-blue-700' : 'text-gray-600 hover:bg-gray-50 hover:text-gray-900'}`}>
                                    <i className="fas fa-chart-pie w-5"></i>
                                    <span>Inventory Profit</span>
                                </button>
                            </nav>
                        </div>
                    </div>
                    <div className="w-3/4">
                        {activeTab === 'labor' && <LaborCostReport />}
                        {activeTab === 'inventoryProfit' && <InventoryProfitReport />}
                    </div>
                </div>
            );
        };

        const Settings = () => {
            const [activeTab, setActiveTab] = useState('profile');

            return (
                <div className="fade-in">
                    <div className="mb-6 border-b border-gray-200">
                        <nav className="-mb-px flex space-x-6" aria-label="Tabs">
                            <button
                                onClick={() => setActiveTab('profile')}
                                className={`${activeTab === 'profile' ? 'border-indigo-500 text-indigo-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`}
                            >
                                User Profile
                            </button>
                            <button
                                onClick={() => setActiveTab('technicians')}
                                className={`${activeTab === 'technicians' ? 'border-indigo-500 text-indigo-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`}
                            >
                                Technicians
                            </button>
                            <button
                                onClick={() => setActiveTab('backup')}
                                className={`${activeTab === 'backup' ? 'border-indigo-500 text-indigo-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`}
                            >
                                Backup & Restore
                            </button>
                        </nav>
                    </div>

                    <div>
                        {activeTab === 'profile' && <UserProfile />}
                        {activeTab === 'technicians' && <Technicians />}
                        {activeTab === 'backup' && <BackupRestoreSettings />}
                    </div>
                </div>
            );
        };
        
        const NotificationsDropdown = () => {
            const { data: notifications, loading, updateItem } = useApi('notifications');
            const [isOpen, setIsOpen] = useState(false);
            
            const unreadCount = notifications ? notifications.filter(n => !n.read).length : 0;
            
            const markAsRead = async (id) => {
                await updateItem(id, { read: true });
            };
            
            const markAllAsRead = async () => {
                if (notifications) {
                    for (const notification of notifications.filter(n => !n.read)) {
                        await markAsRead(notification._id);
                    }
                }
            };

            return (
                <div className="relative">
                    <button 
                        className="notification-bell p-2 rounded-full hover:bg-gray-100" 
                        onClick={() => setIsOpen(!isOpen)}
                    >
                        <i className="fas fa-bell text-gray-600 text-xl"></i>
                        {unreadCount > 0 && <span className="notification-badge">{unreadCount}</span>}
                    </button>
                    
                    {isOpen && (
                        <div className="notification-dropdown">
                            <div className="p-3 border-b flex justify-between items-center">
                                <h3 className="font-semibold">Notifications</h3>
                                {unreadCount > 0 && (
                                    <button 
                                        onClick={markAllAsRead}
                                        className="text-sm text-blue-600 hover:text-blue-800"
                                    >
                                        Mark all as read
                                    </button>
                                )}
                            </div>
                            
                            <div className="max-h-80 overflow-y-auto">
                                {notifications && notifications.length > 0 ? (
                                    notifications.slice(0, 10).map(notification => (
                                        <div 
                                            key={notification._id} 
                                            className={`notification-item ${!notification.read ? 'unread' : ''} notification-${notification.type}`}
                                            onClick={() => markAsRead(notification._id)}
                                        >
                                            <div className="flex items-start">
                                                <div className={`mr-3 mt-1 p-2 rounded-full ${notification.type === 'warning' ? 'bg-yellow-100 text-yellow-600' : 
                                                    notification.type === 'success' ? 'bg-green-100 text-green-600' : 
                                                    notification.type === 'error' ? 'bg-red-100 text-red-600' : 'bg-blue-100 text-blue-600'}`}>
                                                    <i className={`fas ${notification.type === 'warning' ? 'fa-exclamation-triangle' : 
                                                        notification.type === 'success' ? 'fa-check-circle' : 
                                                        notification.type === 'error' ? 'fa-times-circle' : 'fa-info-circle'}`}></i>
                                                </div>
                                                <div className="flex-1">
                                                    <p className="font-medium">{notification.title}</p>
                                                    <p className="text-sm text-gray-600">{notification.message}</p>
                                                    <p className="text-xs text-gray-400 mt-1">{formatDateTime(notification.createdAt)}</p>
                                                </div>
                                                {!notification.read && (
                                                    <div className="ml-2 w-2 h-2 bg-blue-500 rounded-full"></div>
                                                )}
                                            </div>
                                        </div>
                                    ))
                                ) : (
                                    <div className="p-4 text-center text-gray-500">
                                        No notifications
                                    </div>
                                )}
                            </div>
                            
                            <div className="p-3 border-t text-center">
                                <a href="#" className="text-sm text-blue-600 hover:text-blue-800">View all notifications</a>
                            </div>
                        </div>
                    )}
                </div>
            );
        };
        
        const Layout = ({ children }) => {
            const { user, logout } = useAuth();
            const [currentPath, setCurrentPath] = useState(window.location.hash.substring(2).split('/')[0] || 'dashboard');
            
            useEffect(() => {
                const handleHashChange = () => {
                    setCurrentPath(window.location.hash.substring(2).split('/')[0] || 'dashboard');
                };
                
                window.addEventListener('hashchange', handleHashChange);
                return () => window.removeEventListener('hashchange', handleHashChange);
            }, []);
            
            const pageTitles = {
                dashboard: 'Dashboard',
                jobs: 'Repair Jobs',
                customers: 'Customers',
                inventory: 'Inventory',
                reports: 'Reports',
                settings: 'Settings'
            };

            return (
                <div className="flex h-screen">
                    <div className="sidebar text-white flex flex-col">
                        <div className="p-4 border-b border-white/10">
                            <h1 className="text-2xl font-bold">PC <span>Garage</span> Pro</h1>
                        </div>
                        <nav className="flex-1 p-4 space-y-2">
                            <a href="#/dashboard" className={`nav-item ${currentPath === 'dashboard' ? 'active' : ''}`}>
                                <i className="fas fa-tachometer-alt w-5"></i>
                                <span className="nav-text">Dashboard</span>
                            </a>
                            <a href="#/jobs" className={`nav-item ${currentPath === 'jobs' ? 'active' : ''}`}>
                                <i className="fas fa-tools w-5"></i>
                                <span className="nav-text">Jobs</span>
                            </a>
                            <a href="#/customers" className={`nav-item ${currentPath === 'customers' ? 'active' : ''}`}>
                                <i className="fas fa-users w-5"></i>
                                <span className="nav-text">Customers</span>
                            </a>
                            <a href="#/inventory" className={`nav-item ${currentPath === 'inventory' ? 'active' : ''}`}>
                                <i className="fas fa-boxes w-5"></i>
                                <span className="nav-text">Inventory</span>
                            </a>
                            <a href="#/reports" className={`nav-item ${currentPath === 'reports' ? 'active' : ''}`}>
                                <i className="fas fa-chart-line w-5"></i>
                                <span className="nav-text">Reports</span>
                            </a>
                            <a href="#/settings" className={`nav-item ${currentPath === 'settings' ? 'active' : ''}`}>
                                <i className="fas fa-cog w-5"></i>
                                <span className="nav-text">Settings</span>
                            </a>
                        </nav>
                        <div className="p-4 border-t border-white/10">
                            <button onClick={logout} className="nav-item w-full">
                                <i className="fas fa-sign-out-alt w-5"></i>
                                <span className="nav-text">Logout</span>
                            </button>
                        </div>
                    </div>
                    
                    <main className="flex-1 overflow-y-auto p-6">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-2xl font-semibold capitalize">{pageTitles[currentPath] || 'Dashboard'}</h2>
                            <div className="flex items-center gap-4">
                                <NotificationsDropdown />
                                <div className="flex items-center gap-2">
                                    <div className="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center text-white text-sm font-medium">
                                        {user?.name ? user.name.charAt(0) : 'A'}
                                    </div>
                                    <div>
                                        <div className="text-sm font-medium">Welcome, {user?.name || 'Admin'}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {children}
                    </main>
                </div>
            );
        };

        const Login = () => {
            const { login, register } = useAuth();
            const [isLogin, setIsLogin] = useState(true);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [name, setName] = useState('');
            const [confirmPassword, setConfirmPassword] = useState('');
            const [error, setError] = useState('');
            const [success, setSuccess] = useState('');
            
            const handleSubmit = async (e) => { 
                e.preventDefault(); 
                
                if (isLogin) {
                    const result = await login(email, password);
                    if (result.error) {
                        setError(result.error);
                    } else {
                        // The AuthProvider has updated the user state.
                        // Changing the hash will trigger the listener in the App component
                        // to render the dashboard without a full page reload.
                        window.location.hash = '#/dashboard';
                    }
                } else {
                    if (password !== confirmPassword) {
                        setError('Passwords do not match');
                        return;
                    }

                    const result = await register(name, email, password, 'technician');
                    if (result.error) {
                        setError(result.error);
                        setSuccess('');
                    } else {
                        setError('');
                        setSuccess(result.message || 'Registration successful. Please login.');
                        setIsLogin(true);
                    }
                }
            };
            
            return (
                <div className="min-h-screen flex items-center justify-center bg-gray-100">
                    <div className="bg-white p-8 rounded-lg shadow-md w-full max-w-md">
                        <h2 className="text-2xl font-bold text-center mb-6">
                            {isLogin ? 'PC Garage Pro Login' : 'Create Account'}
                        </h2>
                        
                        {error && <div className="p-3 mb-4 bg-red-100 text-red-700 rounded">{error}</div>}
                        {success && <div className="p-3 mb-4 bg-green-100 text-green-700 rounded">{success}</div>}
                        
                        <form onSubmit={handleSubmit} className="space-y-4">
                            {!isLogin && (
                                <div>
                                    <label className="block text-sm font-bold mb-2">Full Name</label>
                                    <input 
                                        type="text" 
                                        placeholder="Enter your name" 
                                        value={name} 
                                        onChange={e => setName(e.target.value)} 
                                        required 
                                        className="w-full p-2 border rounded" 
                                    />
                                </div>
                            )}
                            
                            <div>
                                <label className="block text-sm font-bold mb-2">Email</label>
                                <input 
                                    type="email" 
                                    placeholder="Enter your email" 
                                    value={email} 
                                    onChange={e => setEmail(e.target.value)} 
                                    required 
                                    className="w-full p-2 border rounded" 
                                />
                            </div>
                            
                            <div>
                                <label className="block text-sm font-bold mb-2">Password</label>
                                <input 
                                    type="password" 
                                    placeholder="Enter your password" 
                                    value={password} 
                                    onChange={e => setPassword(e.target.value)} 
                                    required 
                                    className="w-full p-2 border rounded" 
                                />
                            </div>
                            
                            {!isLogin && (
                                <div>
                                    <label className="block text-sm font-bold mb-2">Confirm Password</label>
                                    <input 
                                        type="password" 
                                        placeholder="Confirm your password" 
                                        value={confirmPassword} 
                                        onChange={e => setConfirmPassword(e.target.value)} 
                                        required 
                                        className="w-full p-2 border rounded" 
                                    />
                                </div>
                            )}
                            
                            <button type="submit" className="w-full p-3 bg-blue-600 text-white rounded hover:bg-blue-700">
                                {isLogin ? 'Login' : 'Create Account'}
                            </button>
                        </form>
                        
                        <div className="text-center mt-4">
                            <button 
                                type="button" 
                                onClick={() => {
                                    setIsLogin(!isLogin);
                                    setError('');
                                    setSuccess('');
                                }} 
                                className="text-blue-600 hover:text-blue-800"
                            >
                                {isLogin ? 'Need an account? Sign up' : 'Already have an account? Sign in'}
                            </button>
                        </div>
                        
                        <div className="mt-6 p-4 bg-gray-50 rounded">
                            <p className="text-sm text-center text-gray-600">
                                Demo Credentials:<br />
                                Email: admin@pcgarage.com<br />
                                Password: admin123
                            </p>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const { user, loading } = useAuth();
            const [currentView, setCurrentView] = useState('login');

            useEffect(() => {
                const handleHashChange = () => {
                    const hash = window.location.hash.substring(2).split('/')[0] || 'dashboard';
                    setCurrentView(hash);
                };
                
                window.addEventListener('hashchange', handleHashChange);
                handleHashChange();
                
                return () => window.removeEventListener('hashchange', handleHashChange);
            }, []);

            if (loading) {
                return (
                    <div className="flex items-center justify-center h-screen">
                        <div className="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12"></div>
                    </div>
                );
            }

            if (!user) {
                return <Login />;
            }

            const renderContent = () => {
                switch(currentView) {
                    case 'dashboard': return <Dashboard />;
                    case 'jobs': return <Jobs />;
                    case 'customers': return <Customers />;
                    case 'inventory': return <Inventory />;
                    case 'reports': return <Reports />;
                    case 'settings': return <Settings />;
                    default: return <Dashboard />;
                }
            };

            return <Layout>{renderContent()}</Layout>;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<AuthProvider><App /></AuthProvider>);
    </script>
</body>
</html>